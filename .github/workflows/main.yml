name: Java Test Generation

on: [push]

jobs:
  tests:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        ci_node_total: [8]
        
        ci_node_index: [0, 1, 2, 3, 4, 5, 6, 7]
        
    steps:
    - name: Checkout repository
      uses: actions/checkout@v2
      
    - name: Setup JDK
      uses: actions/setup-java@v1
      with:
        java-version: 1.8
      
    - name: Download Randoop and Emma
      run: |
            wget https://github.com/randoop/randoop/releases/download/v3.0.6/randoop-all-3.0.6.jar -P /home/runner/work/ParallelRandomTesting/ParallelRandomTesting
            
            wget https://sourceforge.net/projects/emma/files/emma-release/2.0.5312/emma-2.0.5312.zip -P /home/runner/work/ParallelRandomTesting/ParallelRandomTesting
      
    - name: Unzip Emma
      run: unzip /home/runner/work/ParallelRandomTesting/ParallelRandomTesting/emma-2.0.5312.zip -d /home/runner/work/ParallelRandomTesting/ParallelRandomTesting
      
    - name: Run emma and randoop
      run: |
            #!/bin/bash
            
            timestamp=${{ matrix.ci_node_index }}
            
            mkdir /home/runner/work/ParallelRandomTesting/ParallelRandomTesting/coverage_$timestamp
            
            #Instr emma
            java -noverify -classpath /home/runner/work/ParallelRandomTesting/ParallelRandomTesting/emma-2.0.5312/lib/emma.jar emma instr -m fullcopy -d /home/runner/work/ParallelRandomTesting/ParallelRandomTesting/coverage_$timestamp -ip /home/runner/work/ParallelRandomTesting/ParallelRandomTesting/jars/saxpath.jar -out coverage_$timestamp/coverage_$timestamp.em

            #Randoop
            java -noverify -classpath /home/runner/work/ParallelRandomTesting/ParallelRandomTesting/coverage_$timestamp/lib/saxpath.jar:/home/runner/work/ParallelRandomTesting/ParallelRandomTesting/emma-2.0.5312/lib/emma.jar:/home/runner/work/ParallelRandomTesting/ParallelRandomTesting/randoop-all-3.0.6.jar randoop.main.Main gentests --classlist=/home/runner/work/ParallelRandomTesting/ParallelRandomTesting/lista.txt --timelimit=150 --no-regression-tests=true --junit-output-dir=/home/runner/work/ParallelRandomTesting/ParallelRandomTesting/coverage_$timestamp
            
            cp coverage.ec /home/runner/work/ParallelRandomTesting/ParallelRandomTesting/coverage_$timestamp/coverage_$timestamp.ec
            rm coverage.ec
            
            #Emma report
            java -classpath /home/runner/work/ParallelRandomTesting/ParallelRandomTesting/emma-2.0.5312/lib/emma.jar emma report -r html  -Dreport.html.out.file=/home/runner/work/ParallelRandomTesting/ParallelRandomTesting/coverage_$timestamp/coverage_$timestamp.html  -in /home/runner/work/ParallelRandomTesting/ParallelRandomTesting/coverage_$timestamp/coverage_$timestamp.em,/home/runner/work/ParallelRandomTesting/ParallelRandomTesting/coverage_$timestamp/coverage_$timestamp.ec
            
            #Emma merge .em e .ec
            java -classpath /home/runner/work/ParallelRandomTesting/ParallelRandomTesting/emma-2.0.5312/lib/emma.jar emma merge -in  /home/runner/work/ParallelRandomTesting/ParallelRandomTesting/coverage_$timestamp/coverage_$timestamp.em,/home/runner/work/ParallelRandomTesting/ParallelRandomTesting/coverage_$timestamp/coverage_$timestamp.ec -out /home/runner/work/ParallelRandomTesting/ParallelRandomTesting/coverage_$timestamp/coverage_$timestamp.es
            
    - name: Upload Emma reports
      uses: actions/upload-artifact@v2
      with:
        name: Emma reports
        path: /home/runner/work/ParallelRandomTesting/ParallelRandomTesting/coverage_?
        
        
  #Job che si attiva al termine di tutte le sessioni di test
  
  merge:
   needs: tests
   runs-on: ubuntu-latest
   steps:
    - name: Checkout repository
      uses: actions/checkout@v2
      
    - name: Setup JDK
      uses: actions/setup-java@v1
      with:
        java-version: 1.8
    
    - name: Download a single artifact
      uses: actions/download-artifact@v3
      with:
       name: Emma reports
       
    - name: Download Emma
      run: wget https://sourceforge.net/projects/emma/files/emma-release/2.0.5312/emma-2.0.5312.zip -P /home/runner/work/ParallelRandomTesting/ParallelRandomTesting
      
    - name: Unzip Emma
      run: unzip /home/runner/work/ParallelRandomTesting/ParallelRandomTesting/emma-2.0.5312.zip -d /home/runner/work/ParallelRandomTesting/ParallelRandomTesting
      
    - name: Emma merge
      run: |
            #!/bin/bash
            count=0
            for file in /home/runner/work/ParallelRandomTesting/ParallelRandomTesting/coverage_?/*.es
            do
             count2=$(($count+1))
             
             FILE=coverage_$count2/coverage_$count2.es
             if test -f "$FILE"; then

                  java -classpath /home/runner/work/ParallelRandomTesting/ParallelRandomTesting/emma-2.0.5312/lib/emma.jar emma merge -in coverage_$count/coverage_$count.es,coverage_$count2/coverage_$count2.es -out coverage_$count2/coverage_$count2.es
                  
                  count=$(($count+1)) 
             fi
            done
            
            cp /home/runner/work/ParallelRandomTesting/ParallelRandomTesting/coverage_$((count))/coverage_$((count)).es /home/runner/work/ParallelRandomTesting/ParallelRandomTesting/coveragemerge.es
 
            #Emma report finale
            java -classpath /home/runner/work/ParallelRandomTesting/ParallelRandomTesting/emma-2.0.5312/lib/emma.jar emma report -r html  -Dreport.html.out.file=/home/runner/work/ParallelRandomTesting/ParallelRandomTesting/coveragemerge/coveragemerge.html  -in /home/runner/work/ParallelRandomTesting/ParallelRandomTesting/coveragemerge.es
            java -classpath /home/runner/work/ParallelRandomTesting/ParallelRandomTesting/emma-2.0.5312/lib/emma.jar emma report -r txt  -Dreport.txt.out.file=/home/runner/work/ParallelRandomTesting/ParallelRandomTesting/coveragemerge/coveragemerge.txt  -in /home/runner/work/ParallelRandomTesting/ParallelRandomTesting/coveragemerge.es
            cp /home/runner/work/ParallelRandomTesting/ParallelRandomTesting/coverage_$((count))/coverage_$((count)).es /home/runner/work/ParallelRandomTesting/ParallelRandomTesting/coveragemerge/coveragemerge.es
            
    - name: Upload Emma reports
      uses: actions/upload-artifact@v2
      with:
        name: Coverage merge
        path: /home/runner/work/ParallelRandomTesting/ParallelRandomTesting/coveragemerge/*
  badge:
    needs: merge
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2
      
    - name: Download a single artifact
      uses: actions/download-artifact@v3
      with:
       name: Coverage merge
       
    #- name: Coverage Badge
  # You may pin to the exact commit or the version.
  # uses: we-cli/coverage-badge-action@8f6b0bd1b727cde6212c8c62d3329c4aac09fec3
     # uses: we-cli/coverage-badge-action@v1.0.1

    - name: Coverage
      run: |
            #!/bin/bash
            value= $(grep -Po (<td class="h">).*(</td>) coveragemerge.html | sed -n 2p)
            echo $value
      
